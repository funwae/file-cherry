#!/usr/bin/env python3
"""
Tail log entries filtered by job ID.

Usage: filecherry-logs [--job-id JOB_ID] [--component COMPONENT] [--lines N]
"""

import argparse
import json
import os
import sys
from pathlib import Path

DATA_DIR = Path(os.getenv("FILECHERRY_DATA_DIR", "/data"))
LOGS_DIR = DATA_DIR / "logs"


def tail_logs(job_id: str = None, component: str = None, lines: int = 50):
    """Tail log entries."""
    if not LOGS_DIR.exists():
        print("No logs directory found.", file=sys.stderr)
        sys.exit(1)

    log_files = []
    if component:
        log_file = LOGS_DIR / f"{component}.log"
        if log_file.exists():
            log_files = [log_file]
    else:
        log_files = list(LOGS_DIR.glob("*.log"))

    if not log_files:
        print("No log files found.", file=sys.stderr)
        sys.exit(1)

    all_entries = []

    for log_file in log_files:
        try:
            with open(log_file, "r") as f:
                for line in f:
                    try:
                        entry = json.loads(line.strip())
                        if job_id and entry.get("job_id") != job_id:
                            continue
                        all_entries.append(entry)
                    except json.JSONDecodeError:
                        continue
        except Exception as e:
            print(f"Error reading {log_file}: {e}", file=sys.stderr)

    # Sort by timestamp
    all_entries.sort(key=lambda x: x.get("timestamp", ""))

    # Print last N entries
    for entry in all_entries[-lines:]:
        timestamp = entry.get("timestamp", "")[:19]  # Remove timezone
        level = entry.get("level", "INFO")
        component = entry.get("component", "unknown")
        message = entry.get("message", "")

        print(f"{timestamp} [{level:5}] {component:20} {message}")


def main():
    """Main entry point."""
    parser = argparse.ArgumentParser(description="Tail FileCherry logs")
    parser.add_argument("--job-id", help="Filter by job ID")
    parser.add_argument("--component", help="Filter by component (orchestrator, ui, etc.)")
    parser.add_argument("--lines", type=int, default=50, help="Number of lines to show (default: 50)")
    args = parser.parse_args()

    tail_logs(job_id=args.job_id, component=args.component, lines=args.lines)


if __name__ == "__main__":
    main()

